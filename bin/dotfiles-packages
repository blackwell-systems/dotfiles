#!/usr/bin/env zsh
# ============================================================
# dotfiles-packages - Package discovery and management
#
# Usage:
#   dotfiles packages              # Show package status
#   dotfiles packages --check      # Show what's missing
#   dotfiles packages --install    # Install missing packages
#   dotfiles packages --outdated   # Show outdated packages
#   dotfiles packages --tier X     # Use specific tier (minimal/enhanced/full)
#
# Compares installed Homebrew packages against Brewfile
# Respects saved tier preference from config.json
# ============================================================
set -uo pipefail

# Find dotfiles directory using paths helper
SCRIPT_DIR="$(cd "$(dirname "${0:A}")" && pwd)"
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/_paths.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/_paths.sh"
    DOTFILES_DIR="${DOTFILES_DIR:-$(get_dotfiles_dir 2>/dev/null || echo "")}"
fi

# Fallback if helper not available
if [[ -z "${DOTFILES_DIR:-}" || ! -d "${DOTFILES_DIR:-}" ]]; then
    if [[ -d "/workspace/dotfiles" ]]; then
        DOTFILES_DIR="/workspace/dotfiles"
    elif [[ -d "$HOME/workspace/dotfiles" ]]; then
        DOTFILES_DIR="$HOME/workspace/dotfiles"
    else
        echo "Error: Could not find dotfiles directory"
        exit 1
    fi
fi

# Source logging functions
source "$DOTFILES_DIR/lib/_logging.sh"

# Source config for tier preference
if [[ -f "$DOTFILES_DIR/lib/_config.sh" ]]; then
    source "$DOTFILES_DIR/lib/_config.sh"
fi

# Flags
CHECK_MODE=false
INSTALL_MODE=false
OUTDATED_MODE=false
TIER_OVERRIDE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --check|-c)
            CHECK_MODE=true
            shift
            ;;
        --install|-i)
            INSTALL_MODE=true
            shift
            ;;
        --outdated|-o)
            OUTDATED_MODE=true
            shift
            ;;
        --tier|-t)
            if [[ -n "${2:-}" ]]; then
                TIER_OVERRIDE="$2"
                shift 2
            else
                fail "--tier requires an argument (minimal/enhanced/full)"
                exit 1
            fi
            ;;
        --help|-h)
            echo ""
            echo -e "${BOLD}dotfiles packages${NC} - ${DIM}Package discovery and management${NC}"
            echo ""
            echo -e "${BOLD}${CYAN}USAGE${NC}"
            echo -e "  ${YELLOW}dotfiles packages${NC}              ${DIM}Show package status overview${NC}"
            echo -e "  ${YELLOW}dotfiles packages${NC} --check      ${DIM}Show what's missing from Brewfile${NC}"
            echo -e "  ${YELLOW}dotfiles packages${NC} --install    ${DIM}Install missing packages${NC}"
            echo -e "  ${YELLOW}dotfiles packages${NC} --outdated   ${DIM}Show outdated packages${NC}"
            echo -e "  ${YELLOW}dotfiles packages${NC} --tier X     ${DIM}Use specific tier (minimal/enhanced/full)${NC}"
            echo ""
            echo -e "${BOLD}${CYAN}TIERS${NC}"
            echo -e "  ${YELLOW}minimal${NC}     ${DIM}~18 packages  - Essentials only${NC}"
            echo -e "  ${YELLOW}enhanced${NC}    ${DIM}~43 packages  - Modern tools, no containers${NC}"
            echo -e "  ${YELLOW}full${NC}        ${DIM}~61 packages  - Everything (Docker, etc.)${NC}"
            echo ""
            echo -e "${BOLD}${CYAN}EXAMPLES${NC}"
            echo -e "  ${YELLOW}dotfiles packages --check${NC}              ${DIM}# See what needs installing${NC}"
            echo -e "  ${YELLOW}dotfiles packages --install${NC}            ${DIM}# Install from saved tier${NC}"
            echo -e "  ${YELLOW}dotfiles packages --install --tier minimal${NC}  ${DIM}# Install minimal tier${NC}"
            echo ""
            echo -e "${DIM}Tier preference is saved during 'dotfiles setup' and persisted in config.json${NC}"
            exit 0
            ;;
        *)
            warn "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Check for Homebrew
if ! command -v brew &>/dev/null; then
    fail "Homebrew not installed"
    echo "Install with: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

# ============================================================
# Determine which Brewfile to use
# Priority: --tier flag > config.json > BREWFILE_TIER env > default (full)
# ============================================================
get_brewfile_tier() {
    # 1. Command line override
    if [[ -n "$TIER_OVERRIDE" ]]; then
        echo "$TIER_OVERRIDE"
        return
    fi

    # 2. Config file (from dotfiles setup)
    if type config_get &>/dev/null; then
        local saved_tier
        saved_tier=$(config_get "packages.tier" "" 2>/dev/null)
        if [[ -n "$saved_tier" ]]; then
            echo "$saved_tier"
            return
        fi
    fi

    # 3. Environment variable
    if [[ -n "${BREWFILE_TIER:-}" ]]; then
        echo "$BREWFILE_TIER"
        return
    fi

    # 4. Default
    echo "full"
}

TIER=$(get_brewfile_tier)

# Map tier to Brewfile
case "$TIER" in
    minimal)
        BREWFILE="$DOTFILES_DIR/Brewfile.minimal"
        ;;
    enhanced)
        BREWFILE="$DOTFILES_DIR/Brewfile.enhanced"
        ;;
    full|*)
        BREWFILE="$DOTFILES_DIR/Brewfile"
        TIER="full"  # Normalize unknown tiers to full
        ;;
esac

# Check Brewfile exists
if [[ ! -f "$BREWFILE" ]]; then
    # Fall back to main Brewfile if tier-specific doesn't exist
    if [[ -f "$DOTFILES_DIR/Brewfile" ]]; then
        warn "Brewfile for '$TIER' tier not found, using full Brewfile"
        BREWFILE="$DOTFILES_DIR/Brewfile"
        TIER="full"
    else
        fail "No Brewfile found at $BREWFILE"
        exit 1
    fi
fi

echo ""
echo -e "${BOLD}Dotfiles Package Manager${NC}"
echo "========================"
echo -e "${DIM}Tier: $TIER ($(basename "$BREWFILE"))${NC}"
echo ""

# ============================================================
# Outdated Mode
# ============================================================
if $OUTDATED_MODE; then
    info "Checking for outdated packages..."
    echo ""

    outdated=$(brew outdated 2>/dev/null)
    if [[ -n "$outdated" ]]; then
        echo "$outdated"
        echo ""
        warn "Run 'brew upgrade' to update packages"
    else
        pass "All packages are up to date"
    fi
    exit 0
fi

# ============================================================
# Check/Install Mode
# ============================================================
info "Analyzing Brewfile ($TIER tier)..."

# Get lists
BREWFILE_FORMULAS=()
BREWFILE_CASKS=()

while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    [[ -z "${line// }" ]] && continue

    if [[ "$line" =~ ^brew[[:space:]]+[\"\']([^\"\']+)[\"\'] ]]; then
        BREWFILE_FORMULAS+=("${match[1]}")
    elif [[ "$line" =~ ^cask[[:space:]]+[\"\']([^\"\']+)[\"\'] ]]; then
        BREWFILE_CASKS+=("${match[1]}")
    fi
done < "$BREWFILE"

# Get installed packages
INSTALLED_FORMULAS=($(brew list --formula 2>/dev/null))
INSTALLED_CASKS=($(brew list --cask 2>/dev/null))

# Find missing
MISSING_FORMULAS=()
MISSING_CASKS=()

for formula in "${BREWFILE_FORMULAS[@]}"; do
    if [[ ! " ${INSTALLED_FORMULAS[*]} " =~ " ${formula} " ]]; then
        MISSING_FORMULAS+=("$formula")
    fi
done

for cask in "${BREWFILE_CASKS[@]}"; do
    if [[ ! " ${INSTALLED_CASKS[*]} " =~ " ${cask} " ]]; then
        MISSING_CASKS+=("$cask")
    fi
done

# ============================================================
# Display Results
# ============================================================
if $CHECK_MODE || [[ ${#MISSING_FORMULAS[@]} -gt 0 || ${#MISSING_CASKS[@]} -gt 0 ]]; then
    echo ""
    echo -e "${BOLD}Brewfile Summary ($TIER):${NC}"
    echo "  Formulas defined: ${#BREWFILE_FORMULAS[@]}"
    echo "  Casks defined: ${#BREWFILE_CASKS[@]}"
    echo ""
    echo -e "${BOLD}Installed:${NC}"
    echo "  Formulas: ${#INSTALLED_FORMULAS[@]}"
    echo "  Casks: ${#INSTALLED_CASKS[@]}"
    echo ""
fi

if [[ ${#MISSING_FORMULAS[@]} -gt 0 ]]; then
    warn "Missing formulas (${#MISSING_FORMULAS[@]}):"
    for formula in "${MISSING_FORMULAS[@]}"; do
        echo "  - $formula"
    done
    echo ""
fi

if [[ ${#MISSING_CASKS[@]} -gt 0 ]]; then
    warn "Missing casks (${#MISSING_CASKS[@]}):"
    for cask in "${MISSING_CASKS[@]}"; do
        echo "  - $cask"
    done
    echo ""
fi

# ============================================================
# Install Mode
# ============================================================
if $INSTALL_MODE; then
    if [[ ${#MISSING_FORMULAS[@]} -eq 0 && ${#MISSING_CASKS[@]} -eq 0 ]]; then
        pass "All Brewfile packages are installed ($TIER tier)"
        exit 0
    fi

    info "Installing missing packages from $TIER tier..."
    echo ""

    # Use brew bundle for proper installation
    if brew bundle check --file="$BREWFILE" &>/dev/null; then
        pass "All packages already installed"
    else
        brew bundle install --file="$BREWFILE"
        if [[ $? -eq 0 ]]; then
            pass "Packages installed successfully ($TIER tier)"
        else
            fail "Some packages failed to install"
            exit 1
        fi
    fi
    exit 0
fi

# ============================================================
# Default: Summary
# ============================================================
if [[ ${#MISSING_FORMULAS[@]} -eq 0 && ${#MISSING_CASKS[@]} -eq 0 ]]; then
    pass "All Brewfile packages are installed ($TIER tier)"
else
    total_missing=$((${#MISSING_FORMULAS[@]} + ${#MISSING_CASKS[@]}))
    warn "$total_missing package(s) missing from $TIER tier"
    echo ""
    echo "Run 'dotfiles packages --check' for details"
    echo "Run 'dotfiles packages --install' to install"
    echo ""
    echo -e "${DIM}Change tier with: dotfiles packages --tier minimal|enhanced|full${NC}"
fi

# ============================================================
# Suggest dotclaude for Claude users
# ============================================================
if command -v claude &>/dev/null && ! command -v dotclaude &>/dev/null; then
    echo ""
    info "Claude Code detected without dotclaude"
    echo "     Manage profiles across machines with dotclaude:"
    echo "     See: github.com/blackwell-systems/dotclaude"
fi
