#!/usr/bin/env zsh
# Migrate vault-items schema from v2 to v3
# v2: Separate ssh_keys and vault_items objects with duplication
# v3: Single flat array with consistent schema

set -euo pipefail

# ============================================================
# Setup
# ============================================================

SCRIPT_DIR="$(cd "$(dirname "${(%):-%x}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source libraries
source "$DOTFILES_DIR/lib/_logging.sh"

# ============================================================
# Configuration
# ============================================================

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles"
VAULT_ITEMS="$CONFIG_DIR/vault-items.json"
BACKUP_DIR="$CONFIG_DIR/backups/vault-schema-v3-$(date +%Y%m%d_%H%M%S)"

# ============================================================
# Check if migration is needed
# ============================================================

check_migration_needed() {
    # If no vault-items.json exists, no migration needed
    if [[ ! -f "$VAULT_ITEMS" ]]; then
        info "No vault-items.json found, no migration needed"
        return 1
    fi

    # Check if already v3 format (has "version" field)
    if jq -e '.version == 3' "$VAULT_ITEMS" >/dev/null 2>&1; then
        info "Vault schema is already v3.0"
        return 1
    fi

    # Check if it's v2 format (has "ssh_keys" or "vault_items")
    if jq -e '.ssh_keys or .vault_items' "$VAULT_ITEMS" >/dev/null 2>&1; then
        return 0
    fi

    warn "Unknown vault-items.json format, skipping migration"
    return 1
}

# ============================================================
# Backup
# ============================================================

backup_vault_items() {
    info "Creating backup..."

    mkdir -p "$BACKUP_DIR"
    cp "$VAULT_ITEMS" "$BACKUP_DIR/vault-items.json"

    pass "Backup created at: $BACKUP_DIR/vault-items.json"
    echo ""
}

# ============================================================
# Migrate v2 â†’ v3
# ============================================================

migrate_vault_schema() {
    info "Migrating vault schema v2 â†’ v3..."
    echo ""

    local tmp_file="$VAULT_ITEMS.tmp"

    # Build v3 schema using jq
    jq '{
      version: 3,
      secrets: [
        # Convert ssh_keys to secrets array
        (.ssh_keys // {} | to_entries[] | {
          name: ("SSH-" + .key),
          path: .value,
          type: "ssh-key",
          required: true,
          sync: "always",
          backup: true
        }),
        # Convert vault_items to secrets array
        (.vault_items // {} | to_entries[] | {
          name: .key,
          path: .value.path,
          type: (.value.type // "file"),
          required: (.value.required // true),
          sync: "manual",
          backup: true
        }),
        # Convert syncable_items to secrets array
        (.syncable_items // {} | to_entries[] |
          # Skip if already in vault_items
          select(.key as $k | ($vault_items // {} | has($k) | not)) | {
          name: .key,
          path: .value,
          type: "file",
          required: false,
          sync: "manual",
          backup: true
        })
      ] | unique_by(.name)
    }' "$VAULT_ITEMS" as $vault_items as $syncable_items > "$tmp_file"

    # Validate output
    if ! jq empty "$tmp_file" 2>/dev/null; then
        fail "Migration produced invalid JSON"
        rm -f "$tmp_file"
        return 1
    fi

    # Count migrated items
    local secret_count
    secret_count=$(jq '.secrets | length' "$tmp_file")

    # Replace original with migrated version
    mv "$tmp_file" "$VAULT_ITEMS"

    pass "Migrated $secret_count secrets to v3 format"
    echo ""
}

# ============================================================
# Show summary
# ============================================================

show_summary() {
    echo ""
    echo "${BOLD}${CYAN}Vault Schema Migration Complete!${NC} ðŸŽ‰"
    echo ""
    echo "${BOLD}What changed:${NC}"
    echo "  â€¢ Schema version: v2 â†’ v3"
    echo "  â€¢ Format: Multiple objects â†’ Single secrets array"
    echo "  â€¢ Eliminated duplication between ssh_keys and vault_items"
    echo ""
    echo "${BOLD}New schema preview:${NC}"
    jq '{version, secrets: (.secrets[:3] + [{"...": "..."}])}' "$VAULT_ITEMS" 2>/dev/null || jq '.' "$VAULT_ITEMS" | head -15
    echo ""
    echo "${BOLD}Total secrets:${NC} $(jq '.secrets | length' "$VAULT_ITEMS")"
    echo ""
    echo "${DIM}Full schema: cat $VAULT_ITEMS${NC}"
}

# ============================================================
# Main
# ============================================================

main() {
    echo ""
    echo "${BOLD}${CYAN}Vault Schema Migration${NC} - v2 â†’ v3"
    echo ""

    # Check if migration is needed
    if ! check_migration_needed; then
        return 0
    fi

    # Create backup
    backup_vault_items

    # Perform migration
    migrate_vault_schema

    # Show summary
    show_summary
}

main "$@"
