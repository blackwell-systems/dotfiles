#!/usr/bin/env zsh
# Migrate config from v2.x (INI) to v3.0 (JSON)

set -euo pipefail

# ============================================================
# Setup
# ============================================================

SCRIPT_DIR="$(cd "$(dirname "${(%):-%x}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source libraries
source "$DOTFILES_DIR/lib/_logging.sh"
source "$DOTFILES_DIR/lib/_config.sh"

# ============================================================
# Migration Configuration
# ============================================================

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles"
OLD_CONFIG="$CONFIG_DIR/config.ini"
NEW_CONFIG="$CONFIG_DIR/config.json"
BACKUP_DIR="$CONFIG_DIR/backups/pre-v3-migration-$(date +%Y%m%d_%H%M%S)"

# ============================================================
# Check if migration is needed
# ============================================================

check_migration_needed() {
    # If JSON config already exists and is valid, no migration needed
    if [[ -f "$NEW_CONFIG" ]]; then
        if config_validate 2>/dev/null; then
            local version
            version=$(config_get "version" "0")
            if [[ "$version" == "3" ]]; then
                info "Config is already v3.0 (JSON format)"
                return 1
            fi
        fi
    fi

    # If no INI config exists, just create default JSON
    if [[ ! -f "$OLD_CONFIG" ]]; then
        info "No legacy config found, creating default v3.0 config"
        init_config
        return 1
    fi

    return 0
}

# ============================================================
# Backup existing config
# ============================================================

backup_config() {
    info "Creating backup..."

    mkdir -p "$BACKUP_DIR"

    # Backup INI config
    if [[ -f "$OLD_CONFIG" ]]; then
        cp "$OLD_CONFIG" "$BACKUP_DIR/config.ini"
        pass "Backed up: config.ini"
    fi

    # Backup JSON config if it exists
    if [[ -f "$NEW_CONFIG" ]]; then
        cp "$NEW_CONFIG" "$BACKUP_DIR/config.json"
        pass "Backed up: config.json"
    fi

    # Backup vault-items.json if it exists
    if [[ -f "$CONFIG_DIR/vault-items.json" ]]; then
        cp "$CONFIG_DIR/vault-items.json" "$BACKUP_DIR/vault-items.json"
        pass "Backed up: vault-items.json"
    fi

    echo ""
    pass "Backup created at: $BACKUP_DIR"
    echo ""
}

# ============================================================
# Migrate INI to JSON
# ============================================================

migrate_ini_to_json() {
    info "Migrating config.ini â†’ config.json..."
    echo ""

    # Start with default config
    get_default_config > "$NEW_CONFIG"

    # Migrate vault section
    local vault_backend
    vault_backend=$(get_ini_value "vault" "backend" "")
    if [[ -n "$vault_backend" ]]; then
        config_set "vault.backend" "$vault_backend"
        pass "Migrated vault.backend: $vault_backend"
    fi

    # Migrate state section (convert to setup.completed array)
    local completed_steps=()

    if [[ $(get_ini_value "state" "symlinks" "")  == "completed" ]]; then
        completed_steps+=("symlinks")
    fi
    if [[ $(get_ini_value "state" "packages" "") == "completed" ]]; then
        completed_steps+=("packages")
    fi
    if [[ $(get_ini_value "state" "vault" "") == "completed" ]]; then
        completed_steps+=("vault")
    fi
    if [[ $(get_ini_value "state" "secrets" "") == "completed" ]]; then
        completed_steps+=("secrets")
    fi

    # Add completed steps to array
    for step in "${completed_steps[@]}"; do
        config_array_add "setup.completed" "$step"
    done

    if [[ ${#completed_steps[@]} -gt 0 ]]; then
        pass "Migrated setup state: ${completed_steps[*]}"
    fi

    # Auto-detect dotfiles_dir if not set
    if [[ -n "${DOTFILES_DIR:-}" ]]; then
        config_set "paths.dotfiles_dir" "$DOTFILES_DIR"
        pass "Set paths.dotfiles_dir: $DOTFILES_DIR"
    fi

    # Set config version
    config_set "version" "3"

    echo ""
    pass "Config migration complete!"
}

# ============================================================
# Show migration summary
# ============================================================

show_summary() {
    echo ""
    echo "${BOLD}${CYAN}Migration Complete!${NC} ðŸŽ‰"
    echo ""
    echo "${BOLD}What changed:${NC}"
    echo "  â€¢ Config format: INI â†’ JSON"
    echo "  â€¢ Location: $NEW_CONFIG"
    echo "  â€¢ Version: 3"
    echo ""
    echo "${BOLD}Backup location:${NC}"
    echo "  $BACKUP_DIR"
    echo ""
    echo "${BOLD}New config:${NC}"
    config_show | head -20
    echo "  ..."
    echo ""
    echo "${DIM}Old config.ini has been preserved but will not be used${NC}"
}

# ============================================================
# Main
# ============================================================

main() {
    echo ""
    echo "${BOLD}${CYAN}Dotfiles Config Migration${NC} - v2.x â†’ v3.0"
    echo ""

    # Check if migration is needed
    if ! check_migration_needed; then
        return 0
    fi

    # Create backup
    backup_config

    # Perform migration
    migrate_ini_to_json

    # Show summary
    show_summary
}

main "$@"
