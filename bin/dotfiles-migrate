#!/usr/bin/env zsh
# Unified v3.0 Migration Tool
# Migrates both config (INIâ†’JSON) and vault schema (v2â†’v3)

set -euo pipefail

# ============================================================
# Setup
# ============================================================

SCRIPT_DIR="$(cd "$(dirname "${(%):-%x}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source libraries
source "$DOTFILES_DIR/lib/_logging.sh"

# ============================================================
# Main Migration
# ============================================================

main() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ${BOLD}Dotfiles v3.0 - Migration Tool${NC}                          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "This tool will migrate your dotfiles configuration to v3.0:"
    echo ""
    echo "  ${CYAN}â€¢${NC} Config format: INI â†’ JSON (with nested structure)"
    echo "  ${CYAN}â€¢${NC} Vault schema: v2 â†’ v3 (simplified single array)"
    echo "  ${CYAN}â€¢${NC} Command names: Already updated to v3.0"
    echo ""
    echo "${DIM}This is a one-time migration. Your old config will be backed up.${NC}"
    echo ""

    # Prompt for confirmation
    if [[ "${1:-}" != "--yes" && "${1:-}" != "-y" ]]; then
        echo -n "Continue with migration? [Y/n]: "
        read -r confirm
        if [[ "${confirm:-Y}" =~ ^[Nn]$ ]]; then
            echo "Migration cancelled"
            return 0
        fi
        echo ""
    fi

    # Run config migration
    echo "${BOLD}${CYAN}[1/2] Config Migration${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    "$SCRIPT_DIR/dotfiles-migrate-config"

    echo ""
    echo ""

    # Run vault schema migration
    echo "${BOLD}${CYAN}[2/2] Vault Schema Migration${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    "$SCRIPT_DIR/dotfiles-migrate-vault-schema"

    echo ""
    echo ""

    # Final summary
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ${BOLD}${GREEN}Migration Complete!${NC}${BOLD} ğŸ‰${NC}                                   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "${BOLD}What's new in v3.0:${NC}"
    echo "  ${GREEN}âœ“${NC} Git-inspired commands: setup, scan, pull, push"
    echo "  ${GREEN}âœ“${NC} Top-level backup & rollback commands"
    echo "  ${GREEN}âœ“${NC} JSON config with custom paths support"
    echo "  ${GREEN}âœ“${NC} Simplified vault schema (no duplication)"
    echo ""
    echo "${BOLD}Next steps:${NC}"
    echo "  ${CYAN}dotfiles doctor${NC}       # Verify everything works"
    echo "  ${CYAN}dotfiles help${NC}         # See all v3.0 commands"
    echo "  ${CYAN}dotfiles vault pull${NC}   # Pull secrets from vault"
    echo ""
    echo "${DIM}All backups are in: ~/.config/dotfiles/backups/${NC}"
}

# Show help
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "Usage: dotfiles migrate [OPTIONS]"
    echo ""
    echo "Migrate dotfiles configuration to v3.0"
    echo ""
    echo "Options:"
    echo "  -y, --yes    Skip confirmation prompt"
    echo "  -h, --help   Show this help"
    echo ""
    echo "This command runs:"
    echo "  1. dotfiles-migrate-config       # INI â†’ JSON"
    echo "  2. dotfiles-migrate-vault-schema # v2 â†’ v3"
    exit 0
fi

main "$@"
