#!/usr/bin/env zsh
# ============================================================
# FILE: bin/dotfiles-config
# Configuration layers management command
# Usage: dotfiles config [command] [options]
# ============================================================
set -uo pipefail

# Determine script location
SCRIPT_DIR="$(cd "$(dirname "${0:a}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

# Source libraries
source "$DOTFILES_DIR/lib/_logging.sh"
source "$DOTFILES_DIR/lib/_config.sh"
source "$DOTFILES_DIR/lib/_config_layers.sh"

# ============================================================
# Colors (for consistent output)
# ============================================================
GREEN="${GREEN:-\033[0;32m}"
RED="${RED:-\033[0;31m}"
YELLOW="${YELLOW:-\033[0;33m}"
CYAN="${CYAN:-\033[0;36m}"
BOLD="${BOLD:-\033[1m}"
DIM="${DIM:-\033[2m}"
NC="${NC:-\033[0m}"

# ============================================================
# Commands
# ============================================================

cmd_get() {
    local key="${1:-}"
    local default="${2:-}"

    if [[ -z "$key" ]]; then
        echo "Usage: dotfiles config get <key> [default]" >&2
        echo "Example: dotfiles config get vault.backend bitwarden" >&2
        return 1
    fi

    config_get_layered "$key" "$default"
}

cmd_set() {
    local layer="${1:-}"
    local key="${2:-}"
    local value="${3:-}"

    if [[ -z "$layer" || -z "$key" || -z "$value" ]]; then
        echo "Usage: dotfiles config set <layer> <key> <value>" >&2
        echo "Layers: user, machine, project" >&2
        echo "Examples:" >&2
        echo "  dotfiles config set user vault.backend 1password" >&2
        echo "  dotfiles config set machine features.debug true" >&2
        echo "  dotfiles config set project shell.theme minimal" >&2
        return 1
    fi

    config_set_layered "$layer" "$key" "$value"
    echo -e "${GREEN}✓${NC} Set ${CYAN}$key${NC} = ${BOLD}$value${NC} in ${YELLOW}$layer${NC} config"
}

cmd_show() {
    local key="${1:-}"

    if [[ -z "$key" ]]; then
        echo "Usage: dotfiles config show <key>" >&2
        echo "Shows value from all layers and which one is active" >&2
        echo "Example: dotfiles config show vault.backend" >&2
        return 1
    fi

    config_show_layers "$key"
}

cmd_source() {
    local key="${1:-}"
    local default="${2:-}"

    if [[ -z "$key" ]]; then
        echo "Usage: dotfiles config source <key> [default]" >&2
        echo "Returns JSON with value and its source layer" >&2
        echo "Example: dotfiles config source vault.backend" >&2
        return 1
    fi

    config_get_with_source "$key" "$default"
}

cmd_list() {
    echo -e "${BOLD}Configuration Layers${NC}"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""
    echo -e "${BOLD}Layer Locations:${NC}"
    echo "───────────────────────────────────────────────────────────────"

    # Environment
    printf "  %-12s %s\n" "env:" "${DIM}DOTFILES_* environment variables${NC}"

    # Project
    local project_config
    project_config=$(_find_project_config) || true
    if [[ -n "$project_config" ]]; then
        printf "  %-12s %s ${GREEN}✓${NC}\n" "project:" "$project_config"
    else
        printf "  %-12s %s\n" "project:" "${DIM}.dotfiles.json (not found)${NC}"
    fi

    # Machine
    if [[ -f "$CONFIG_LAYER_MACHINE" ]]; then
        printf "  %-12s %s ${GREEN}✓${NC}\n" "machine:" "$CONFIG_LAYER_MACHINE"
    else
        printf "  %-12s %s\n" "machine:" "${DIM}$CONFIG_LAYER_MACHINE (not found)${NC}"
    fi

    # User
    if [[ -f "$CONFIG_LAYER_USER" ]]; then
        printf "  %-12s %s ${GREEN}✓${NC}\n" "user:" "$CONFIG_LAYER_USER"
    else
        printf "  %-12s %s\n" "user:" "${DIM}$CONFIG_LAYER_USER (not found)${NC}"
    fi

    echo ""
    echo -e "${BOLD}Priority:${NC} env > project > machine > user > default"
    echo ""
}

cmd_merged() {
    echo -e "${BOLD}Merged Configuration${NC}"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""
    config_show_merged
}

cmd_init() {
    local layer="${1:-}"
    local identifier="${2:-}"

    case "$layer" in
        machine)
            config_init_machine "$identifier"
            ;;
        project)
            config_init_project
            ;;
        *)
            echo "Usage: dotfiles config init <layer> [identifier]" >&2
            echo "Layers: machine, project" >&2
            echo "Examples:" >&2
            echo "  dotfiles config init machine work-macbook" >&2
            echo "  dotfiles config init project" >&2
            return 1
            ;;
    esac
}

cmd_edit() {
    local layer="${1:-user}"
    local editor="${EDITOR:-vim}"
    local config_file

    case "$layer" in
        user)
            config_file="$CONFIG_LAYER_USER"
            ;;
        machine)
            config_file="$CONFIG_LAYER_MACHINE"
            ;;
        project)
            config_file=$(_find_project_config) || true
            if [[ -z "$config_file" ]]; then
                echo "No project config found. Create one with: dotfiles config init project" >&2
                return 1
            fi
            ;;
        *)
            echo "Usage: dotfiles config edit [layer]" >&2
            echo "Layers: user (default), machine, project" >&2
            return 1
            ;;
    esac

    if [[ ! -f "$config_file" ]]; then
        echo "Config file does not exist: $config_file" >&2
        echo "Create it with: dotfiles config init $layer" >&2
        return 1
    fi

    "$editor" "$config_file"
}

# ============================================================
# Help
# ============================================================

show_help() {
    cat <<EOF
${BOLD}dotfiles config${NC} - Configuration layers management

${BOLD}USAGE${NC}
    dotfiles config <command> [options]

${BOLD}COMMANDS${NC}
    ${CYAN}get${NC} <key> [default]       Get config value (with layer resolution)
    ${CYAN}set${NC} <layer> <key> <value> Set config value in specific layer
    ${CYAN}show${NC} <key>                Show value from all layers
    ${CYAN}source${NC} <key> [default]    Get value with source information (JSON)
    ${CYAN}list${NC}                      Show layer locations and status
    ${CYAN}merged${NC}                    Show merged config from all layers
    ${CYAN}init${NC} <layer> [id]         Initialize a config layer
    ${CYAN}edit${NC} [layer]              Edit config file (default: user)

${BOLD}LAYERS${NC} (in priority order)
    ${YELLOW}env${NC}        Environment variables (DOTFILES_*)
    ${YELLOW}project${NC}    Project-specific (.dotfiles.json)
    ${YELLOW}machine${NC}    Machine-specific (~/.config/dotfiles/machine.json)
    ${YELLOW}user${NC}       User preferences (~/.config/dotfiles/config.json)

${BOLD}EXAMPLES${NC}
    ${DIM}# Get a config value${NC}
    dotfiles config get vault.backend bitwarden

    ${DIM}# Set user preference${NC}
    dotfiles config set user vault.backend 1password

    ${DIM}# See where a value comes from${NC}
    dotfiles config show vault.backend

    ${DIM}# Override with environment variable${NC}
    export DOTFILES_VAULT_BACKEND=pass
    dotfiles config get vault.backend

    ${DIM}# Initialize machine-specific config${NC}
    dotfiles config init machine work-macbook

    ${DIM}# Create project config${NC}
    cd ~/projects/myapp
    dotfiles config init project

${BOLD}CONFIG KEY FORMAT${NC}
    Keys use dot notation: vault.backend, features.debug, shell.theme
    Environment variables: DOTFILES_VAULT_BACKEND, DOTFILES_FEATURES_DEBUG
EOF
}

# ============================================================
# Main
# ============================================================

main() {
    local cmd="${1:-}"
    shift 2>/dev/null || true

    case "$cmd" in
        get)     cmd_get "$@" ;;
        set)     cmd_set "$@" ;;
        show)    cmd_show "$@" ;;
        source)  cmd_source "$@" ;;
        list)    cmd_list "$@" ;;
        merged)  cmd_merged "$@" ;;
        init)    cmd_init "$@" ;;
        edit)    cmd_edit "$@" ;;
        help|--help|-h)
            show_help
            ;;
        "")
            show_help
            ;;
        *)
            echo "Unknown command: $cmd" >&2
            echo "Run 'dotfiles config help' for usage" >&2
            return 1
            ;;
    esac
}

main "$@"
