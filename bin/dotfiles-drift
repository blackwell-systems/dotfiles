#!/usr/bin/env zsh
# ============================================================
# FILE: dotfiles-drift.sh
# Compare local configuration files against vault
# Works with any configured vault backend (Bitwarden, 1Password, pass)
# Usage: ./dotfiles-drift.sh
#        dotfiles drift
#        dotfiles drift --quick   # Fast local-only check (no vault access)
# ============================================================
set -uo pipefail

# Source shared logging functions
SCRIPT_DIR="$(cd "$(dirname "${0:a}")" && pwd)"
# DOTFILES_DIR is parent of bin/
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$DOTFILES_DIR/lib/_logging.sh"
source "$DOTFILES_DIR/lib/_drift.sh"

# Parse arguments
QUICK_MODE=false
while [[ $# -gt 0 ]]; do
    case "$1" in
        --quick|-q)
            QUICK_MODE=true
            shift
            ;;
        --help|-h)
            echo "Compare local configuration files against vault"
            echo ""
            echo "Usage: dotfiles drift [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --quick, -q   Fast check against cached state (no vault access)"
            echo "  --help, -h    Show this help"
            echo ""
            echo "Quick mode compares local files against the last vault pull."
            echo "Full mode connects to vault and compares current vault contents."
            exit 0
            ;;
        *)
            fail "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Quick mode - use cached state, no vault access needed
if [[ "$QUICK_MODE" == "true" ]]; then
    drift_check_verbose
    exit $?
fi

# Full mode - connect to vault
source "$DOTFILES_DIR/lib/_vault.sh"

# Initialize vault backend
if ! vault_init; then
    fail "Failed to initialize vault backend"
    exit 1
fi

BACKEND_NAME=$(vault_name)
section "Drift Detection (Local vs $BACKEND_NAME)"

# Check if logged in
if ! vault_login_check; then
    warn "$BACKEND_NAME not unlocked - cannot check drift"
    echo ""
    case "$DOTFILES_VAULT_BACKEND" in
        bitwarden)
            info "Run: export BW_SESSION=\"\$(bw unlock --raw)\""
            ;;
        1password)
            info "Run: eval \$(op signin)"
            ;;
        pass)
            info "Ensure GPG agent is running"
            ;;
    esac
    exit 1
fi

# Get session
SESSION=$(vault_get_session)

# Sync first
info "Syncing $BACKEND_NAME vault..."
vault_sync "$SESSION" >/dev/null 2>&1 || true

# Items to check for drift
typeset -A DRIFT_ITEMS=(
    ["SSH-Config"]="$HOME/.ssh/config"
    ["AWS-Config"]="$HOME/.aws/config"
    ["AWS-Credentials"]="$HOME/.aws/credentials"
    ["Git-Config"]="$HOME/.gitconfig"
    ["Environment-Secrets"]="$HOME/.local/env.secrets"
    ["Claude-Profiles"]="$HOME/.claude/profiles.json"
)

DRIFT_COUNT=0
CHECKED_COUNT=0

for item_name in "${(@k)DRIFT_ITEMS}"; do
    local_file="${DRIFT_ITEMS[$item_name]}"

    # Skip if local file doesn't exist
    if [[ ! -f "$local_file" ]]; then
        info "$item_name: local file not found ($local_file)"
        continue
    fi

    # Get vault content using abstraction
    vault_content=$(vault_get_notes "$item_name" "$SESSION" 2>/dev/null || echo "")

    if [[ -z "$vault_content" ]]; then
        info "$item_name: not found in $BACKEND_NAME"
        continue
    fi

    ((CHECKED_COUNT++))

    # Compare
    local_content=$(cat "$local_file")
    if [[ "$vault_content" == "$local_content" ]]; then
        pass "$item_name: in sync"
    else
        warn "$item_name: LOCAL DIFFERS from $BACKEND_NAME"
        ((DRIFT_COUNT++))
    fi
done

echo ""
echo "========================================"
if [[ $DRIFT_COUNT -eq 0 ]]; then
    echo -e "${GREEN}All $CHECKED_COUNT checked items are in sync${NC}"
else
    echo -e "${YELLOW}$DRIFT_COUNT of $CHECKED_COUNT items have drifted${NC}"
    echo ""
    info "To sync local changes to $BACKEND_NAME:"
    echo "  dotfiles vault sync --all"
    echo ""
    info "To restore from $BACKEND_NAME (overwrite local):"
    echo "  dotfiles vault restore"
fi
echo "========================================"
