#!/usr/bin/env zsh
# ============================================================
# FILE: dotfiles-init
# Interactive first-time setup wizard
# Usage: dotfiles init
# ============================================================
set -uo pipefail

# Source shared logging functions
SCRIPT_DIR="$(cd "$(dirname "${0:a}")" && pwd)"
# DOTFILES_DIR is parent of bin/
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$DOTFILES_DIR/lib/_logging.sh"
source "$DOTFILES_DIR/lib/_vault.sh"

# Additional init-specific function
step()  { echo -e "\n${BOLD}${CYAN}==> $1${NC}"; }

echo ""
echo -e "${BOLD}${CYAN}"
cat << 'EOF'
    ____        __  _____ __
   / __ \____  / /_/ __(_) /__  _____
  / / / / __ \/ __/ /_/ / / _ \/ ___/
 / /_/ / /_/ / /_/ __/ / /  __(__  )
/_____/\____/\__/_/ /_/_/\___/____/

         First-Time Setup Wizard
EOF
echo -e "${NC}"

# Check if already initialized
step "Checking current state"

NEEDS_SETUP=false

if [[ ! -L "$HOME/.zshrc" ]]; then
    warn "zshrc not linked"
    NEEDS_SETUP=true
else
    pass "zshrc linked"
fi

# Detect available vault backends
AVAILABLE_VAULTS=()
if command -v bw &>/dev/null; then
    AVAILABLE_VAULTS+=("bitwarden")
fi
if command -v op &>/dev/null; then
    AVAILABLE_VAULTS+=("1password")
fi
if command -v pass &>/dev/null; then
    AVAILABLE_VAULTS+=("pass")
fi

if [[ ${#AVAILABLE_VAULTS[@]} -eq 0 ]]; then
    warn "No vault CLI installed (optional)"
    NEEDS_SETUP=true
else
    # Check if DOTFILES_VAULT_BACKEND is explicitly set
    if [[ -n "${DOTFILES_VAULT_BACKEND:-}" ]]; then
        SELECTED_BACKEND="$DOTFILES_VAULT_BACKEND"
        # Check if selected backend is logged in
        if vault_check_login "$SELECTED_BACKEND" 2>/dev/null; then
            pass "$SELECTED_BACKEND vault configured"
        else
            warn "$SELECTED_BACKEND vault not logged in"
            NEEDS_SETUP=true
        fi
    else
        # No backend explicitly set - will prompt during setup
        warn "Vault backend not configured"
        NEEDS_SETUP=true
    fi
fi

if ! $NEEDS_SETUP; then
    echo ""
    pass "Dotfiles already initialized!"
    echo ""
    echo "Quick commands:"
    echo "  dotfiles status    - Visual dashboard"
    echo "  dotfiles doctor    - Health check"
    echo "  dotfiles help      - All commands"
    exit 0
fi

# Step 1: Run bootstrap if needed
step "Step 1: Bootstrap"

if [[ ! -L "$HOME/.zshrc" ]]; then
    echo "Running bootstrap to create symlinks..."
    echo -n "Continue? [Y/n]: "
    read confirm
    if [[ "${confirm:-Y}" =~ ^[Yy]$ ]]; then
        if [[ "$(uname -s)" == "Darwin" ]]; then
            "$DOTFILES_DIR/bootstrap/bootstrap-mac.sh"
        else
            "$DOTFILES_DIR/bootstrap/bootstrap-linux.sh"
        fi
        pass "Bootstrap complete"
    else
        warn "Skipped bootstrap"
    fi
else
    pass "Bootstrap already done"
fi

# Step 2: Vault setup (backend-agnostic)
step "Step 2: Vault Setup"

if [[ ${#AVAILABLE_VAULTS[@]} -eq 0 ]]; then
    echo "No vault CLI detected. Vault features are optional."
    echo ""
    echo "Supported vault backends:"
    echo "  • Bitwarden:  brew install bitwarden-cli"
    echo "  • 1Password:  brew install 1password-cli"
    echo "  • pass:       brew install pass"
    echo ""
    echo -n "Skip vault setup? [Y/n]: "
    read skip
    if [[ "${skip:-Y}" =~ ^[Yy]$ ]]; then
        warn "Skipped vault setup - you can configure secrets manually"
        VAULT_CONFIGURED=false
    else
        echo "Please install a vault CLI and run 'dotfiles init' again."
        exit 1
    fi
else
    # Always prompt for vault backend choice (even if only one detected)
    echo "Detected vault backends:"
    for i in {1..${#AVAILABLE_VAULTS[@]}}; do
        echo "  $i) ${AVAILABLE_VAULTS[$i]}"
    done
    echo "  $((${#AVAILABLE_VAULTS[@]} + 1))) Skip vault setup (configure secrets manually)"
    echo ""

    echo -n "Select vault backend [1]: "
    read choice
    choice=${choice:-1}

    # Check if user chose to skip
    if [[ $choice -eq $((${#AVAILABLE_VAULTS[@]} + 1)) ]]; then
        warn "Skipped vault setup - you can configure secrets manually"
        VAULT_CONFIGURED=false
        # Jump to next step
    else
        SELECTED_BACKEND="${AVAILABLE_VAULTS[$choice]}"

        # Export for other scripts
        export DOTFILES_VAULT_BACKEND="$SELECTED_BACKEND"

        echo "Using vault backend: $SELECTED_BACKEND"
        echo ""

    # Backend-specific login/unlock
    case "$SELECTED_BACKEND" in
        bitwarden)
            if ! bw login --check &>/dev/null; then
                echo "Log in to Bitwarden:"
                bw login
            fi

            if ! vault_check_login "$SELECTED_BACKEND" 2>/dev/null; then
                echo ""
                echo "Unlock your vault:"
                echo -n "Run 'bw unlock' now? [Y/n]: "
                read confirm
                if [[ "${confirm:-Y}" =~ ^[Yy]$ ]]; then
                    export BW_SESSION="$(bw unlock --raw)"
                    if [[ -n "$BW_SESSION" ]]; then
                        pass "Vault unlocked"
                        # Cache session
                        vault_save_session "$SELECTED_BACKEND" "$BW_SESSION"
                        VAULT_CONFIGURED=true
                    fi
                fi
            else
                pass "Vault already unlocked"
                VAULT_CONFIGURED=true
            fi
            ;;

        1password)
            if ! op account list &>/dev/null 2>&1; then
                echo "Sign in to 1Password:"
                op signin
            fi

            if op account list &>/dev/null 2>&1; then
                pass "1Password authenticated"
                VAULT_CONFIGURED=true
            else
                warn "1Password authentication failed"
                VAULT_CONFIGURED=false
            fi
            ;;

        pass)
            # pass uses GPG agent, check if we can list passwords
            if pass ls &>/dev/null 2>&1; then
                pass "pass accessible (GPG agent active)"
                VAULT_CONFIGURED=true
            else
                warn "pass not accessible - check GPG configuration"
                echo "You may need to:"
                echo "  • Import your GPG key"
                echo "  • Initialize pass: pass init <gpg-key-id>"
                VAULT_CONFIGURED=false
            fi
            ;;
    esac
    fi
fi

# Step 3: Restore secrets
step "Step 3: Restore Secrets"

if [[ "${VAULT_CONFIGURED:-false}" == "true" ]]; then
    echo "Would you like to restore secrets from $SELECTED_BACKEND?"
    echo "This will restore: SSH keys, AWS credentials, Git config, etc."
    echo ""
    echo -n "Restore secrets? [Y/n]: "
    read confirm
    if [[ "${confirm:-Y}" =~ ^[Yy]$ ]]; then
        "$DOTFILES_DIR/vault/bootstrap-vault.sh"
        pass "Secrets restored"
    else
        warn "Skipped secret restore"
    fi
else
    warn "Skipped (vault not configured)"
    echo "Configure secrets manually in: ~/.ssh, ~/.aws, ~/.gitconfig"
fi

# Step 4: Claude Code Setup (optional)
if command -v claude &>/dev/null; then
    step "Step 4: Claude Code Setup"

    if ! command -v dotclaude &>/dev/null; then
        echo "Claude Code detected. dotclaude helps manage profiles across machines."
        echo ""
        echo -n "Install dotclaude? [Y/n]: "
        read response
        if [[ "${response:-Y}" =~ ^[Yy]$ ]]; then
            curl -fsSL https://raw.githubusercontent.com/blackwell-systems/dotclaude/main/install.sh | bash
            if command -v dotclaude &>/dev/null; then
                pass "dotclaude installed"
            else
                warn "Installation may require shell restart"
            fi
        else
            info "Skipped - install later: github.com/blackwell-systems/dotclaude"
        fi
    else
        pass "dotclaude already installed"
        local profile=$(dotclaude active 2>/dev/null)
        if [[ -n "$profile" && "$profile" != "none" ]]; then
            pass "Active Claude profile: $profile"
        else
            echo "Create a profile with: dotclaude create <name>"
        fi
    fi
fi

# Step 5: Health check
step "Step 5: Health Check"

echo "Running health check..."
"$DOTFILES_DIR/bin/dotfiles-doctor" || true

# Complete
step "Setup Complete!"

echo ""
echo "Quick commands:"
echo "  dotfiles status         - Visual dashboard"
echo "  dotfiles doctor         - Health check"
if [[ "${VAULT_CONFIGURED:-false}" == "true" ]]; then
    echo "  dotfiles vault restore  - Restore secrets ($SELECTED_BACKEND)"
fi
echo "  dotfiles help           - All commands"
echo ""
echo -e "${YELLOW}${BOLD}>>> Run 'exec zsh' to start using your new shell <<<${NC}"
echo ""
