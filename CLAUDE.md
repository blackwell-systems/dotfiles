# Claude Code Session Guidelines

> For user documentation, see [README.md](README.md) or [docs/](docs/)

---

## Architecture Overview

The **Feature Registry** (`internal/feature/registry.go`) is the control plane for the entire system. Everything flows through it.

```
┌─────────────────────────────────────────────────────────────┐
│                    Feature Registry                          │
│            (internal/feature/registry.go)                    │
│                                                              │
│  - Controls what's enabled/disabled                          │
│  - Resolves dependencies between features                    │
│  - Persists state to config.json                            │
│  - Provides presets (minimal, developer, claude, full)       │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
   ┌───────────┐       ┌───────────┐       ┌───────────┐
   │  Go CLI   │       │ Vaultmux  │       │   Shell   │
   │  (Cobra)  │       │  Library  │       │   (Zsh)   │
   └───────────┘       └───────────┘       └───────────┘
```

**Key principle:** New functionality registers as a feature in Go. The registry controls loading.

**Architecture:** Go-first with shell enhancement layer
- **Go binary** (`cmd/blackdot/main.go`) - All core functionality
- **Shell functions** (`zsh/zsh.d/*.zsh`) - Aliases and integrations that call Go binary
- **Shell helpers** (`lib/*.sh`) - Only colors, hooks, logging (3 files)

---

## Adding a New Feature

### 1. Register the feature (Go)

In `internal/feature/registry.go`, add to `NewRegistry()`:

```go
// Optional features
r.register("my_feature", CategoryOptional, "My Feature Description",
    []string{"dependency1"}, DefaultFalse)
```

Categories: `CategoryCore`, `CategoryOptional`, `CategoryIntegration`
Defaults: `DefaultTrue`, `DefaultFalse`, `DefaultEnv`

### 2. Add CLI command (Go)

Create `internal/cli/my_feature.go`:

```go
package cli

import (
    "github.com/spf13/cobra"
)

func newMyFeatureCmd() *cobra.Command {
    cmd := &cobra.Command{
        Use:   "my-feature",
        Short: "Manage my feature",
        RunE: func(cmd *cobra.Command, args []string) error {
            // Implementation
            return nil
        },
    }
    return cmd
}
```

Register in `internal/cli/root.go`:

```go
rootCmd.AddCommand(
    // ... existing commands
    newMyFeatureCmd(),
)
```

### 3. Add shell integration (if needed)

In `zsh/zsh.d/*.zsh`, add aliases that check features:

```bash
# Only load if feature enabled
if feature_enabled "my_feature"; then
    alias myf='blackdot my-feature'
fi
```

**Note:** `feature_enabled` is a shell function generated by `blackdot shell-init` that calls the Go binary.

### 4. Update documentation

- `docs/features.md` - Add feature description
- `docs/cli-reference.md` - Add CLI command

**That's it.** The Go registry handles enable/disable, persistence, and presets.

---

## Project Structure

```
blackdot/
├── cmd/blackdot/             # Go CLI entry point
│   └── main.go
├── internal/
│   ├── cli/                  # Cobra commands (30+ files, ~19K lines)
│   │   ├── root.go
│   │   ├── features.go       # Feature management
│   │   ├── vault.go          # Vault operations
│   │   ├── doctor.go         # Health checks
│   │   ├── completion.go     # Shell completions
│   │   └── ...
│   ├── feature/              # Feature registry
│   │   └── registry.go
│   └── config/               # JSON config management
│       └── config.go
├── bootstrap/                # Platform bootstrap scripts
├── brew/                     # Homebrew Brewfiles (minimal/enhanced/full)
├── docker/                   # Docker configurations
├── lib/                      # Minimal shell helpers (3 files)
├── zsh/zsh.d/                # Shell modules (aliases, integrations)
├── powershell/               # PowerShell module for Windows
├── vault/                    # Vault item templates
└── docs/                     # Documentation + assets
```

### Key Files

| File | Purpose |
|------|---------|
| `internal/feature/registry.go` | Feature Registry - the control plane |
| `internal/config/config.go` | JSON config read/write |
| `internal/cli/*.go` | All CLI commands (Go) |
| `cmd/blackdot/main.go` | CLI entry point |
| `zsh/zsh.d/00-init.zsh` | Shell initialization (`eval "$(blackdot shell-init)"`) |

---

## Quick Commands

```bash
blackdot features              # List all features
blackdot features enable X     # Enable feature
blackdot features disable X    # Disable feature
blackdot features preset Y     # Apply preset (minimal/developer/claude/full)
blackdot doctor                # Health check
blackdot doctor --fix          # Auto-fix issues
blackdot status                # Visual dashboard
blackdot vault restore         # Restore secrets from vault
blackdot completion zsh        # Generate shell completions
blackdot backup restore --dry-run  # Preview restore (many commands support --dry-run)
```

---

## Configuration Management

All configuration is managed through the Go CLI:

```bash
# Get config value
blackdot config get vault.backend

# Set config value
blackdot config set vault.backend bitwarden

# Show config hierarchy
blackdot config show vault.backend
```

Configuration stored in: `~/.config/blackdot/config.json`

---

## Coding Standards (Go)

```go
package cli

import (
    "github.com/spf13/cobra"
)

func newMyCmd() *cobra.Command {
    cmd := &cobra.Command{
        Use:   "my-command",
        Short: "Brief description",
        Long:  `Detailed description`,
        RunE: func(cmd *cobra.Command, args []string) error {
            // Implementation
            return nil
        },
    }

    cmd.Flags().StringP("flag", "f", "", "flag description")
    return cmd
}
```

**Shell scripts** (minimal - only for aliases/integrations):
```bash
# Check feature before using
if feature_enabled "my_feature"; then
    alias myalias='blackdot my-command'
fi
```

---

## Testing

**Go tests:**
```bash
go test ./...                    # Run all Go tests
go test ./internal/feature       # Test feature registry
go test -v -cover ./...          # With coverage
```

**Integration tests:**
```bash
go run ./cmd/blackdot features list
go run ./cmd/blackdot vault status
```

**Shell syntax check:**
```bash
shellcheck lib/*.sh zsh/zsh.d/*.zsh
```

---

## Documentation Updates

When changing features, update:
1. `README.md` - Root documentation
2. `docs/README.md` - Docsify homepage
3. `docs/features.md` - Feature registry docs
4. `docs/cli-reference.md` - CLI commands
5. `doc.go` - Go package documentation

---

## Git Rules

- Always `git fetch && git status` before working
- Never `git push --force`
- Use conventional commits: `feat:`, `fix:`, `docs:`, `refactor:`

The repository has hooks that block dangerous git commands.

---

## Vault System (vaultmux)

Vault operations use the external `vaultmux` Go library:

```go
import "github.com/blackwell-systems/vaultmux"

backend, err := vaultmux.New(vaultmux.Config{
    Backend: vaultmux.BackendBitwarden,
    SessionFile: sessionFile,
    Prefix: "blackdot",
})
```

See `internal/cli/vault.go` for implementation details.

All vault shell scripts have been deleted (6,000 lines). The Go implementation is the only vault system.

---

## Cross-Platform Support

**Shells:**
- **Zsh** (macOS/Linux) - `zsh/zsh.d/*.zsh`
- **PowerShell** (Windows) - `powershell/Blackdot.psm1`

**Installers:**
- **Unix** - `install.sh` (Bash)
- **Windows** - `install-windows.ps1` (PowerShell)

All CLI commands work identically across platforms via the Go binary.

---

*Last Updated: 2025-12-11*
