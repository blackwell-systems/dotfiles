# Devcontainer Integration

> **Status:** Planning
> **Author:** Claude
> **Created:** 2025-12-12

## Overview

Extend blackdot to support devcontainer environments, enabling "your dev environment, anywhere" for containerized development workflows including GitHub Codespaces, local Docker, and remote VMs.

## Problem Statement

Developers using devcontainers face the same setup challenges as new machines:
- Installing and configuring tools
- Managing secrets (SSH keys, AWS credentials, API tokens)
- Consistent shell configuration
- Personal preferences that should follow them

Currently, devcontainer users must either:
1. Manually set up each container (time-consuming, inconsistent)
2. Bake credentials into images (security risk)
3. Use complex volume mounts (fragile, host-dependent)

## Solution

Add devcontainer support as a feature of blackdot:

1. **`blackdot devcontainer init`** - Generate .devcontainer/ configuration
2. **Published devcontainer feature** - `ghcr.io/blackwell-systems/blackdot`
3. **Interactive vault restore** - User authenticates when container starts

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    User's Project                            │
├─────────────────────────────────────────────────────────────┤
│  .devcontainer/                                              │
│  ├── devcontainer.json    ← Generated by blackdot           │
│  └── (optional Dockerfile)                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              devcontainer.json                               │
├─────────────────────────────────────────────────────────────┤
│  {                                                           │
│    "image": "mcr.microsoft.com/devcontainers/go:1.22",      │
│    "features": {                                             │
│      "ghcr.io/blackwell-systems/blackdot:1": {              │
│        "preset": "developer"                                 │
│      }                                                       │
│    },                                                        │
│    "postStartCommand": "blackdot setup"                      │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Container Startup Flow                          │
├─────────────────────────────────────────────────────────────┤
│  1. Container created with base image (Go, Rust, etc.)      │
│  2. Blackdot feature installed (binary + shell config)       │
│  3. postStartCommand runs: blackdot setup                    │
│  4. User interactively authenticates to vault                │
│  5. Secrets restored, tools installed, shell configured      │
│  6. Ready to develop                                         │
└─────────────────────────────────────────────────────────────┘
```

## Design Decisions

### 1. Use Microsoft's Base Images

**Decision:** Leverage existing devcontainer images, don't build our own.

**Rationale:**
- Microsoft maintains high-quality, regularly updated images
- Covers all major languages (Go, Rust, Python, Node, etc.)
- Community already familiar with them
- Reduces maintenance burden

**Supported base images:**
```
mcr.microsoft.com/devcontainers/go:1.22
mcr.microsoft.com/devcontainers/rust:latest
mcr.microsoft.com/devcontainers/python:3.12
mcr.microsoft.com/devcontainers/typescript-node:20
mcr.microsoft.com/devcontainers/base:ubuntu
mcr.microsoft.com/devcontainers/base:alpine
mcr.microsoft.com/devcontainers/base:debian
```

### 2. Interactive Authentication

**Decision:** User authenticates to vault interactively when container starts.

**Rationale:**
- User IS present (sitting at terminal/browser)
- More secure than tokens/env vars
- Simpler implementation
- Session persists for container lifetime

**Flow:**
```
$ blackdot setup
[INFO] Configuring blackdot...
[INFO] Vault backend: bitwarden

Bitwarden login required.
? Email: user@example.com
? Master password: ********

[OK] Vault unlocked
[OK] SSH keys restored (3 keys)
[OK] AWS credentials configured
[OK] Git config applied
```

### 3. Blackdot Presets Handle Tool Selection

**Decision:** Use existing blackdot presets instead of separate feature selection.

**Rationale:**
- Presets already define tool combinations
- Consistent with non-container blackdot usage
- Simpler mental model
- No duplicate configuration

**Presets:**
| Preset | Features |
|--------|----------|
| minimal | Shell config only |
| developer | vault, aws_helpers, git_hooks, modern_cli |
| claude | claude_integration, workspace_symlink, vault, git_hooks |
| full | All features enabled |

### 4. Devcontainer Feature Distribution

**Decision:** Publish blackdot as a devcontainer feature to ghcr.io.

**Rationale:**
- Standard distribution mechanism
- Easy to consume in any devcontainer.json
- Versioned releases
- Works with Codespaces, VS Code, DevPod, etc.

**Feature structure:**
```
ghcr.io/blackwell-systems/blackdot:1
├── devcontainer-feature.json
├── install.sh
└── (installs blackdot binary + shell integration)
```

## CLI Design

### `blackdot devcontainer init`

Interactive command to generate .devcontainer/ configuration.

```
$ blackdot devcontainer init

Blackdot Devcontainer Setup
===========================

Select base image:
  1. Go 1.22
  2. Rust (latest)
  3. Python 3.12
  4. Node 20 (TypeScript)
  5. Ubuntu (base)
  6. Alpine (base)
  7. Custom image...

> 1

Select blackdot preset:
  1. minimal    - Shell config only (fastest)
  2. developer  - Vault, AWS, Git hooks, modern CLI
  3. claude     - Claude Code integration + vault
  4. full       - All features

> 2

Generated:
  .devcontainer/devcontainer.json

Next steps:
  1. Commit .devcontainer/ to your repository
  2. Open in VS Code or Codespaces
  3. Run 'blackdot setup' when container starts
```

**Flags:**
```
--image <image>     Base image (skip interactive selection)
--preset <preset>   Blackdot preset (skip interactive selection)
--output <dir>      Output directory (default: .devcontainer)
--force             Overwrite existing configuration
```

### Generated devcontainer.json

```json
{
  "name": "Development Container",
  "image": "mcr.microsoft.com/devcontainers/go:1.22",
  "features": {
    "ghcr.io/blackwell-systems/blackdot:1": {
      "preset": "developer",
      "version": "latest"
    }
  },
  "postStartCommand": "blackdot setup --preset developer",
  "customizations": {
    "vscode": {
      "extensions": [
        "golang.go"
      ]
    }
  },
  "remoteUser": "vscode"
}
```

## Implementation Plan

### Phase 1: Core CLI Command ✅
**Effort:** 1 day

- [x] Create `internal/cli/devcontainer.go`
- [x] Implement `blackdot devcontainer init` command
- [x] Hardcoded list of common base images
- [x] Template for devcontainer.json generation
- [x] Interactive prompts for image and preset selection
- [x] Flag support for non-interactive usage

**Files:**
```
internal/cli/devcontainer.go     (~380 lines)
internal/cli/devcontainer_test.go (~330 lines)
```

### Phase 2: Devcontainer Feature ✅
**Effort:** 0.5 days

- [x] Create feature definition in `devcontainer-feature/`
- [x] Write install.sh script
- [x] Create devcontainer-feature.json manifest
- [x] Test locally with devcontainer CLI

**Files:**
```
devcontainer-feature/
├── devcontainer-feature.json
├── install.sh
└── README.md
```

### Phase 3: CI/CD & Publishing ✅
**Effort:** 0.5 days

- [x] Add GitHub Action to publish feature to ghcr.io
- [x] Version tagging (match blackdot releases)
- [x] Documentation updates

**Files:**
```
.github/workflows/devcontainer-feature.yml
docs/devcontainers.md
```

### Phase 4: Testing & Polish
**Effort:** 0.5 days

- [ ] Test with GitHub Codespaces
- [ ] Test with local VS Code devcontainers
- [ ] Test all base images
- [ ] Test all presets
- [ ] Add to `blackdot doctor` checks

## Devcontainer Feature Specification

### devcontainer-feature.json

```json
{
  "id": "blackdot",
  "version": "1.0.0",
  "name": "Blackdot",
  "description": "Vault-backed configuration management for development environments",
  "documentationURL": "https://github.com/blackwell-systems/blackdot",
  "options": {
    "preset": {
      "type": "string",
      "enum": ["minimal", "developer", "claude", "full"],
      "default": "developer",
      "description": "Blackdot preset to apply"
    },
    "version": {
      "type": "string",
      "default": "latest",
      "description": "Blackdot version to install"
    }
  },
  "installsAfter": [
    "ghcr.io/devcontainers/features/common-utils"
  ]
}
```

### install.sh

```bash
#!/bin/bash
set -e

PRESET="${PRESET:-developer}"
VERSION="${VERSION:-latest}"

echo "Installing Blackdot (preset: $PRESET, version: $VERSION)..."

# Download and install blackdot binary
if [ "$VERSION" = "latest" ]; then
    curl -fsSL https://blackdot.dev/install | bash
else
    curl -fsSL https://blackdot.dev/install | bash -s -- --version "$VERSION"
fi

# Verify installation
blackdot version

# Add shell integration to profile
echo 'eval "$(blackdot shell-init)"' >> /etc/bash.bashrc
echo 'eval "$(blackdot shell-init)"' >> /etc/zsh/zshrc

echo "Blackdot installed successfully"
echo "Run 'blackdot setup' to configure your environment"
```

## Testing Strategy

### Unit Tests
- Command flag parsing
- Template generation
- Image list handling

### Integration Tests
- Generate devcontainer.json and validate structure
- Test with devcontainer CLI (`devcontainer build`)

### E2E Tests (Manual)
- GitHub Codespaces with generated config
- VS Code Remote Containers
- DevPod

## Documentation

### docs/devcontainers.md

New documentation page covering:
- Overview and benefits
- Quick start guide
- Supported base images
- Preset descriptions
- Customization options
- Troubleshooting

### Updates to existing docs
- README.md: Add devcontainers to feature list
- docs/README.md: Add to sidebar
- docs/cli-reference.md: Add devcontainer command

## Future Enhancements

### Nice to Have (Post-MVP)
- Fetch image list from GitHub API
- Custom Dockerfile generation
- Docker Compose support
- SSH agent forwarding setup
- VS Code extension recommendations per language

### Out of Scope
- Building/maintaining base images
- Non-interactive vault auth (CI/CD)
- Kubernetes/Helm charts

## Success Metrics

1. **Adoption:** Users generating devcontainer configs
2. **Time saved:** Setup time in containers vs manual
3. **Consistency:** Same environment across machines/containers

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Microsoft changes image names | Use stable tags, document alternatives |
| Feature registry API changes | Pin to stable devcontainer spec version |
| Vault auth complexity | Clear error messages, troubleshooting docs |

## References

- [Devcontainer Specification](https://containers.dev/)
- [Devcontainer Features](https://containers.dev/features)
- [Microsoft Devcontainer Images](https://github.com/devcontainers/images)
- [GitHub Codespaces](https://github.com/features/codespaces)
