name: CI

on:
  push:
    branches: [ main, master, 'claude/**', 'feature/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Go binary build and test on all platforms
  go-test:
    name: Go Tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...

      - name: Vet
        run: go vet ./...

  # Build binaries for all platforms
  go-build-matrix:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          SUFFIX=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            SUFFIX=".exe"
          fi
          go build -ldflags="-s -w" -o blackdot-${{ matrix.goos }}-${{ matrix.goarch }}${SUFFIX} ./cmd/blackdot/
          ls -la blackdot-*

  # Shell script validation (remaining scripts)
  shell-validation:
    name: Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh shellcheck

      - name: Validate bash scripts
        run: |
          echo "Validating bash scripts..."
          SCRIPTS=(
            bootstrap/bootstrap-mac.sh
            bootstrap/bootstrap-linux.sh
            bootstrap/bootstrap-windows.sh
            bootstrap/_common.sh
            install.sh
          )
          for script in "${SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              shellcheck -S warning "$script" || true
            fi
          done
          echo "Done!"

      - name: Validate zsh scripts
        run: |
          echo "Validating ZSH script syntax..."
          # Check remaining ZSH files
          for script in zsh/zsh.d/*.zsh lib/*.sh vault/*.sh; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              zsh -n "$script" || exit 1
            fi
          done
          echo "All ZSH scripts have valid syntax!"

  # PowerShell validation
  powershell-validation:
    name: PowerShell Scripts
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Write-Host "Validating PowerShell scripts..."
          $scripts = @(
            "powershell/Install-Blackdot.ps1",
            "powershell/Blackdot.psm1",
            "powershell/Install-Packages.ps1",
            "install-windows.ps1",
            "Install.ps1"
          )
          foreach ($script in $scripts) {
            if (Test-Path $script) {
              Write-Host "Checking $script..."
              $errors = $null
              [void][System.Management.Automation.Language.Parser]::ParseFile(
                (Resolve-Path $script),
                [ref]$null,
                [ref]$errors
              )
              if ($errors) {
                Write-Host "Syntax errors in $script :" -ForegroundColor Red
                $errors | ForEach-Object { Write-Host $_.Message }
                exit 1
              }
            }
          }
          Write-Host "All PowerShell scripts valid!"

      - name: Test PowerShell module import
        shell: pwsh
        run: |
          Write-Host "Testing PowerShell module import..."
          $modulePath = Join-Path $PWD "powershell/Blackdot.psm1"
          Import-Module $modulePath -Force -ErrorAction Stop
          Write-Host "✅ Module imported successfully"

          # Verify key functions exist
          $requiredFunctions = @(
            "Invoke-BlackdotHook",
            "Register-BlackdotHook",
            "Get-BlackdotHook",
            "Enable-BlackdotHooks",
            "Disable-BlackdotHooks"
          )
          foreach ($func in $requiredFunctions) {
            if (Get-Command $func -ErrorAction SilentlyContinue) {
              Write-Host "✅ $func exists"
            } else {
              Write-Host "❌ $func not found"
              exit 1
            }
          }
          Write-Host "All required functions present!"

      - name: Validate packages.json
        shell: pwsh
        run: |
          Write-Host "Validating packages.json..."
          $json = Get-Content "powershell/packages.json" -Raw | ConvertFrom-Json
          # winget schema: sources[0].packages
          if ($json.sources -and $json.sources[0].packages) {
            $count = ($json.sources[0].packages | Measure-Object).Count
            Write-Host "✅ Found $count packages defined"
          } else {
            Write-Host "❌ No packages array found (expected sources[0].packages)"
            exit 1
          }

  # Integration tests - actually run the binary on each platform
  integration-tests:
    name: Integration (${{ matrix.os }})
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            binary: ./blackdot
            shell_type: zsh
          - os: macos-latest
            binary: ./blackdot
            shell_type: zsh
          - os: windows-latest
            binary: ./blackdot.exe
            shell_type: powershell
    runs-on: ${{ matrix.os }}
    env:
      # Point to checkout directory so binary finds templates/configs
      BLACKDOT_DIR: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build binary (Unix)
        if: matrix.os != 'windows-latest'
        run: go build -o blackdot ./cmd/blackdot/

      - name: Build binary (Windows)
        if: matrix.os == 'windows-latest'
        run: go build -o blackdot.exe ./cmd/blackdot/

      - name: Test version command
        run: ${{ matrix.binary }} version

      - name: Test features list
        run: ${{ matrix.binary }} features list

      - name: Test features presets
        run: ${{ matrix.binary }} features presets

      - name: Test doctor command
        # Doctor returns non-zero when health checks fail (expected in CI)
        # We just verify the command runs and produces output
        shell: bash
        run: ${{ matrix.binary }} doctor || echo "Doctor reported issues (expected in CI)"

      - name: Test config list
        run: ${{ matrix.binary }} config list

      - name: Test template list
        run: ${{ matrix.binary }} template list

      - name: Test shell-init (zsh)
        if: matrix.shell_type == 'zsh'
        run: |
          output=$(${{ matrix.binary }} shell-init zsh)
          if echo "$output" | grep -q "feature_enabled"; then
            echo "✅ shell-init zsh outputs correct functions"
          else
            echo "❌ shell-init zsh output missing expected functions"
            exit 1
          fi

      - name: Test shell-init (powershell)
        if: matrix.shell_type == 'powershell'
        shell: pwsh
        run: |
          $output = ${{ matrix.binary }} shell-init powershell
          if ($output -match "Test-FeatureEnabled") {
            Write-Host "✅ shell-init powershell outputs correct functions"
          } else {
            Write-Host "❌ shell-init powershell output missing expected functions"
            exit 1
          }

      - name: Test help commands
        run: |
          ${{ matrix.binary }} help
          ${{ matrix.binary }} features --help
          ${{ matrix.binary }} vault --help

  # Repository structure check
  structure-check:
    name: Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking repository structure..."
          REQUIRED=(
            "README.md"
            "CHANGELOG.md"
            "Brewfile"
            "zsh/zshrc"
            "zsh/p10k.zsh"
            "cmd/blackdot/main.go"
            "internal/cli/root.go"
            "lib/_logging.sh"
            "lib/_hooks.sh"
            "lib/_colors.sh"
          )
          MISSING=0
          for file in "${REQUIRED[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing: $file"
              ((MISSING++))
            else
              echo "✅ Found: $file"
            fi
          done
          if [[ $MISSING -gt 0 ]]; then
            echo "❌ $MISSING required file(s) missing"
            exit 1
          fi
          echo "All required files present!"
