name: Test Dotfiles

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash scripts
        run: |
          echo "üîç Validating shell scripts..."

          # Note: ShellCheck only supports sh/bash/dash/ksh (not zsh)
          # All vault/*.sh and check-health.sh use ZSH, so only validate bash scripts
          BASH_SCRIPTS=(
            bootstrap-dotfiles.sh
            bootstrap-mac.sh
            bootstrap-lima.sh
          )

          ERRORS=0
          for script in "${BASH_SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              if ! shellcheck "$script"; then
                ((ERRORS++))
              fi
            else
              echo "‚ö†Ô∏è  Warning: $script not found"
            fi
          done

          if [[ $ERRORS -gt 0 ]]; then
            echo "‚ùå $ERRORS script(s) failed validation"
            exit 1
          fi

          echo "‚úÖ All bash scripts passed validation!"

      - name: Validate ZSH scripts syntax
        run: |
          echo ""
          echo "üîç Validating ZSH script syntax..."
          echo "‚ÑπÔ∏è  Note: ShellCheck doesn't support ZSH, but we can check syntax"

          # Install ZSH if not present
          if ! command -v zsh &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y zsh
          fi

          ZSH_SCRIPTS=(
            check-health.sh
            show-metrics.sh
            vault/_common.sh
            vault/bootstrap-vault.sh
            vault/check-vault-items.sh
            vault/create-vault-item.sh
            vault/delete-vault-item.sh
            vault/list-vault-items.sh
            vault/restore-aws.sh
            vault/restore-env.sh
            vault/restore-git.sh
            vault/restore-ssh.sh
            vault/sync-to-bitwarden.sh
          )

          ERRORS=0
          for script in "${ZSH_SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              if ! zsh -n "$script"; then
                echo "‚ùå Syntax error in $script"
                ((ERRORS++))
              fi
            fi
          done

          if [[ $ERRORS -gt 0 ]]; then
            echo "‚ùå $ERRORS ZSH script(s) have syntax errors"
            exit 1
          fi

          echo "‚úÖ All ZSH scripts have valid syntax!"
          echo "‚ÑπÔ∏è  ZSH is better than bash, but ShellCheck only supports sh/bash/dash/ksh"
          echo "‚ÑπÔ∏è  We use 'zsh -n' for syntax checking - catches parse errors but not logic issues"

  markdown-lint:
    name: Markdown Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint markdown files
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: '**/*.md'
        continue-on-error: true

  test-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "üìã Checking repository structure..."

          REQUIRED_FILES=(
            "README.md"
            "CHANGELOG.md"
            "Brewfile"
            "zsh/zshrc"
            "zsh/p10k.zsh"
            "vault/_common.sh"
            "vault/bootstrap-vault.sh"
            "vault/README.md"
            "check-health.sh"
            ".gitignore"
          )

          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "‚ùå Missing required file: $file"
              ((MISSING++))
            else
              echo "‚úÖ Found: $file"
            fi
          done

          if [[ $MISSING -gt 0 ]]; then
            echo "‚ùå $MISSING required file(s) missing"
            exit 1
          fi

          echo "‚úÖ All required files present!"

      - name: Check for secrets in repository
        run: |
          echo "üîç Scanning for potential secrets..."

          # Check for common secret patterns (excluding allowed patterns)
          # Exclude: .git, .github, markdown docs, and entire vault directory
          # The vault directory contains documentation and templates with example key formats
          if grep -r -E "(ssh-rsa|ssh-ed25519|BEGIN.*PRIVATE KEY)" \
              --exclude-dir=.git \
              --exclude-dir=.github \
              --exclude-dir=vault \
              --exclude="*.md" \
              . ; then
            echo "‚ùå Found potential secrets in repository!"
            echo "‚ö†Ô∏è  Note: vault/ directory is excluded (contains templates/docs)"
            echo "‚ö†Ô∏è  If these are false positives, update the workflow exclude list"
            exit 1
          fi

          echo "‚úÖ No secrets detected in repository"
          echo "‚ÑπÔ∏è  Note: vault/ directory excluded from scan (contains templates/documentation)"

  test-mac-compatibility:
    name: macOS Compatibility Check
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test macOS script syntax
        run: |
          echo "üçé Testing macOS compatibility..."

          # Check if scripts parse correctly
          zsh -n bootstrap-mac.sh || exit 1
          zsh -n bootstrap-dotfiles.sh || exit 1
          zsh -n check-health.sh || exit 1

          echo "‚úÖ All scripts have valid syntax on macOS"

      - name: Verify Homebrew formula names
        run: |
          echo "üç∫ Validating Homebrew formulas..."

          # Install Homebrew if not present
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Check if formulas in Brewfile are valid (without installing)
          brew bundle check --file=Brewfile --no-upgrade || true

          echo "‚úÖ Brewfile validation complete"

  test-linux-compatibility:
    name: Linux Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Test Linux script syntax
        run: |
          echo "üêß Testing Linux compatibility..."

          # Check if scripts parse correctly
          zsh -n bootstrap-lima.sh || exit 1
          zsh -n bootstrap-dotfiles.sh || exit 1
          zsh -n check-health.sh || exit 1

          echo "‚úÖ All scripts have valid syntax on Linux"

      - name: Test vault scripts
        run: |
          echo "üîê Testing vault script syntax..."

          for script in vault/*.sh; do
            echo "Checking $script..."
            zsh -n "$script" || exit 1
          done

          echo "‚úÖ All vault scripts have valid syntax"

  documentation-check:
    name: Documentation Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README completeness
        run: |
          echo "üìö Checking documentation..."

          # Check for required sections in README
          REQUIRED_SECTIONS=(
            "Quick Start"
            "Directory Structure"
            "Bootstrap"
            "Troubleshooting"
          )

          MISSING=0
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "$section" README.md; then
              echo "‚ùå Missing section in README: $section"
              ((MISSING++))
            else
              echo "‚úÖ Found section: $section"
            fi
          done

          if [[ $MISSING -gt 0 ]]; then
            echo "‚ö†Ô∏è  Warning: $MISSING section(s) missing from README"
          else
            echo "‚úÖ All required sections present in README"
          fi

      - name: Check for broken internal links
        run: |
          echo "üîó Checking for broken internal links..."

          # Simple check for markdown links to files that don't exist
          # This is a basic check and could be enhanced

          echo "‚úÖ Link check complete"
