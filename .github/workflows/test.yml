name: Test Dotfiles

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Go tests (primary test suite)
  go-tests:
    name: Go Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

  # Shell script validation
  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash scripts
        run: |
          echo "Validating shell scripts..."
          BASH_SCRIPTS=(
            bootstrap/bootstrap-mac.sh
            bootstrap/bootstrap-linux.sh
            bootstrap/bootstrap-windows.sh
            bootstrap/_common.sh
            install.sh
          )
          ERRORS=0
          for script in "${BASH_SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              if ! shellcheck -S warning "$script"; then
                ((ERRORS++))
              fi
            fi
          done
          if [[ $ERRORS -gt 0 ]]; then
            echo "FAIL: $ERRORS script(s) failed validation"
            exit 1
          fi
          echo "All bash scripts passed!"

      - name: Validate ZSH scripts syntax
        run: |
          echo "Validating ZSH script syntax..."
          sudo apt-get install -y zsh
          # Check vault scripts
          for script in vault/*.sh; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              zsh -n "$script" || exit 1
            fi
          done
          # Check zsh.d modules
          for script in zsh/zsh.d/*.zsh; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              zsh -n "$script" || exit 1
            fi
          done
          echo "All ZSH scripts valid!"

  # Bats unit tests (for vault shell scripts)
  unit-tests:
    name: Shell Unit Tests (bats-core)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bats zsh jq

      - name: Make mock executable
        run: chmod +x test/mocks/bw 2>/dev/null || true

      - name: Run unit tests
        run: |
          if ls test/*.bats 1> /dev/null 2>&1; then
            bats --timing test/*.bats || true
          else
            echo "No bats tests found"
          fi

  test-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking repository structure..."
          REQUIRED_FILES=(
            "README.md"
            "CHANGELOG.md"
            "Brewfile"
            "zsh/zshrc"
            "cmd/dotfiles/main.go"
            "internal/cli/root.go"
            ".gitignore"
          )
          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing: $file"
              ((MISSING++))
            else
              echo "Found: $file"
            fi
          done
          if [[ $MISSING -gt 0 ]]; then
            exit 1
          fi
          echo "All required files present!"

  test-mac:
    name: macOS Compatibility
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build and test Go binary
        run: |
          go build -o bin/dotfiles ./cmd/dotfiles/
          ./bin/dotfiles version
          ./bin/dotfiles features list
          echo "Go binary works on macOS"

      - name: Test script syntax
        run: |
          zsh -n bootstrap/bootstrap-mac.sh
          for script in zsh/zsh.d/*.zsh; do
            zsh -n "$script" || exit 1
          done

  test-linux:
    name: Linux Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Build and test Go binary
        run: |
          go build -o bin/dotfiles ./cmd/dotfiles/
          ./bin/dotfiles version
          ./bin/dotfiles features list
          echo "Go binary works on Linux"

      - name: Test script syntax
        run: |
          zsh -n bootstrap/bootstrap-linux.sh
          for script in zsh/zsh.d/*.zsh vault/*.sh; do
            zsh -n "$script" || exit 1
          done
